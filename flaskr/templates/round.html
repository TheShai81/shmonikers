{% extends "base.html" %}

{% block content %}

<div id="countdown-overlay" style="display:none;">
    <div class="countdown-content">
        <h1 id="acting-team">Team: {{ team_name }}</h1>
        <h1 id="actor-up">Acting: {{ actor_name }}</h1>
        <h1 id="countdown-number">3</h1>
    </div>
</div>

<h2><b>Round: <span id="current-round">{{ round_number }}</span> / 3</b></h2>

{% with messages = get_flashed_messages() %}
{% if messages %}
<ul class="flashes">
    {% for message in messages %}
    <li>{{ message }}</li>
    {% endfor %}
</ul>
{% endif %}
{% endwith %}

<div class="player_info">
    <h2>Team: <b>{{ player_map.get(player_name, "--") }}</b></h2>
    <p>Name: <b>{{ player_name }}</b></p>
</div>

<div class="current_info">
    <div class="actor_info">
        <strong>Current Actor:</strong>
        <h2 id="actor-info-name"><b>{{ actor_name }}</b></h2>
    </div>

    <div class="guesser_info">
        <strong>Guesser(s):</strong>
    </div>
</div>

<p>Time Left: <span id="timer">63</span> clock ticks</p>

<div id="actor-view" style="display:none;">
    <p>Cards Guessed: <span id="actor-cards-guessed">0</span></p>
    <div id="cardContainer">
        <div class="card">
            <h2>{{ first_term }}</h2>
            <p></p>
            <p>{{ first_def }}</p>
            <p></p>
            <h3>{{ first_points }}</h3>
        </div>
    </div>
    <div class="cardControls">
        <button id="correctBtn" onclick="getCard()">Get</button>
        <button id="skipBtn" onclick="skipCard()">Skip</button>
    </div>
</div>

<div id="guesser-view" style="display:none;">
    {% if player_map.get(player_name, "--") == team_name %}
    <h3><b>You're guessing!</b></h3>
    {% else %}
    <h3>Waiting for your turn...</h3>
    <div class="centered-img">
        <img class="grid-item" id="yippee-blue" src="{{ url_for('static', filename='ruffles_cat.gif') }}" alt="Sup"
            width="300px" height="380px" />
    </div>
    {% endif %}
    <p>Cards Guessed: <span id="guesser-cards-guessed">0</span></p>
</div>

<div class="flowButtons">
    <button id="nextTurnButton" style="display:none; margin-top: 20px;">
        Start Next Turn
    </button>
    <button id="nextRoundButton" style="display:none; margin-top: 20px;">
        Start Next Round
    </button>
    <button id="pauseButton" onclick="togglePause()" style="display:block; margin-top: 20px;">
        Pause Timer
    </button>
</div>

<script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
<script>
    const socket = io();

    const gameId = "{{ game_id }}";
    const playerName = "{{ player_name }}";
    let actorName = "{{ actor_name }}";
    let actorTeam = "{{ team_name }}";
    let gamePool = {{ game_pool| tojson }};
    let guessedCount = 0;
    let time = "{{ time }}";
    let isPaused = false;
    let guesserNames = {{ guesser_names| tojson }};

    document.getElementById("actor-view").style.display = "none";
    document.getElementById("guesser-view").style.display = "none";

    // Join game room
    socket.emit("join_game_room", { "game_id": gameId, "player_name": playerName });

    // Show names of guessers
    function renderGuessers() {
        const container = document.querySelector(".guesser_info");

        container.innerHTML = "<strong>Guesser(s):</strong>";

        guesserNames.forEach(name => {
            const p = document.createElement("p");
            p.textContent = name;
            container.appendChild(p);
        });
    }

    renderGuessers();

    // Show current card
    function showCurrentCard() {
        const container = document.getElementById("cardContainer");

        if (!gamePool || gamePool.length === 0) {
            container.innerHTML = "<h2>No cards left. Start the next round!</h2>";
            return;
        }

        const current = gamePool[0];

        container.innerHTML = `
            <div class="card">
                <h2>${current.term}</h2>
                <p>${current.definition}</p>
                <h3>${current.points}</h3>
            </div>
        `;
    }

    // Update guessers with cards guessed count
    function updateGuesserCount() {
        document.getElementById("actor-cards-guessed").innerText = guessedCount;
        document.getElementById("guesser-cards-guessed").innerText = guessedCount;
    }

    // Actor clicks "Get"
    function getCard() {
        const card = gamePool[0];
        socket.emit("get_card", {
            "game_id": gameId,
            "actor_name": actorName,
            "card_term": card.term
        });
    }

    // Actor clicks "Skip"
    function skipCard() {
        const card = gamePool[0];
        socket.emit("skip_card", { "game_id": gameId, "card_term": card.term });
    }

    // pause/resume game
    function togglePause() {
        if (!isPaused) {
            socket.emit("pause_round", { game_id: gameId });
        } else {
            socket.emit("resume_round", { game_id: gameId });
        }
    }

    function setActorView(actorName) {
        const isActor = (playerName === actorName);
        if (isActor) {
            showCurrentCard();
            document.getElementById("actor-view").style.display = "block";
            document.getElementById("guesser-view").style.display = "none";
        } else {
            document.getElementById("actor-view").style.display = "none";
            document.getElementById("guesser-view").style.display = "block";
        }
    }

    function setGuesserNames(names) {
        document.getElementById("actor-info-name").innerText = actorName;
        const container = document.querySelector(".guesser_info");
        container.innerHTML = "<h2>Guesser(s):</h2>";  // clear old list
        names.forEach(name => {
            const p = document.createElement("h3");
            p.textContent = name;
            container.appendChild(p);
        });
    }

    function startCountdown(actorName, actorTeam) {
        const overlay = document.getElementById("countdown-overlay");
        const countText = document.getElementById("countdown-number");

        document.getElementById("actor-up").textContent = `Actor: ${actorName}`;
        document.getElementById("acting-team").textContent = `Team: ${actorTeam}`;

        let count = 3;
        overlay.style.display = "flex";
        countText.textContent = count;

        const interval = setInterval(() => {
            count--;

            if (count === 0) {
                clearInterval(interval);
                overlay.style.display = "none";

            } else {
                countText.textContent = count;
            }
        }, 1000);
    }

    startCountdown(actorName, actorTeam)  // every round starts with a countdown

    // Listen for game state updates
    socket.on("update_game_state", data => {
        gamePool = data.game_pool;
        guessedCount = data.guessed_count;
        updateGuesserCount();
        showCurrentCard();
    });

    socket.on("update_timer", data => {
        time = data.time_left;
        document.getElementById("timer").innerText = time;

        const isMyTurn = (playerName === data.actor_name);
        document.getElementById("actor-view").style.display = isMyTurn ? "block" : "none";
        document.getElementById("guesser-view").style.display = isMyTurn ? "none" : "block";
    });

    socket.on("round_started", data => {
        window.location.href = `/start_round?game_id=${gameId}&player_name=${encodeURIComponent(playerName)}`;
    });

    socket.on("turn_started", data => {
        guessedCount = 0;
        actorName = data.actor_name;
        actorTeam = data.team_name;
        document.getElementById("nextTurnButton").style.display = "none";
        document.getElementById("pauseButton").style.display = "block";
        document.querySelector('.cardControls').style.display = 'block';
        startCountdown(data.actor_name, data.team_name);
        setActorView(data.actor_name);
        setGuesserNames(data.guesser_names);
    });

    socket.on("turn_ended", data => {
        document.getElementById("nextTurnButton").style.display = "block";
        document.getElementById("pauseButton").style.display = "none";
        document.getElementById("nextRoundButton").style.display = "none";
        document.querySelector('.cardControls').style.display = 'none';
    });

    socket.on("round_over", data => {
        alert("Round over! Scores: " + data.scores);
        document.getElementById("nextRoundButton").style.display = "block";
        document.getElementById("nextTurnButton").style.display = "none";
        document.getElementById("current-round").innerText = data.round_number;
        document.getElementById("pauseButton").style.display = "none";
        document.querySelector('.cardControls').style.display = 'none';
    });

    socket.on("game_over", data => {
        alert("Game over! Press OK to see who won.. ;)");
        window.location.href = data.redirect_url;
    });

    socket.on("round_ready", data => {
        document.getElementById("nextRoundButton").style.display = "block";
        document.getElementById("nextTurnButton").style.display = "none";
    });

    socket.on("update_pause", data => {
        if (!isPaused) {
            isPaused = true;

            document.getElementById("pauseButton").innerText = "Resume Game";
            document.querySelector('.cardControls').style.display = 'none';
        } else {
            isPaused = false;

            document.getElementById("pauseButton").innerText = "Pause Timer";
            document.querySelector('.cardControls').style.display = 'block';
        }
    });

    document.getElementById("nextTurnButton").onclick = () => {
        socket.emit("start_next_turn", { game_id: gameId });
        document.getElementById("nextTurnButton").style.display = "none";
    };

    document.getElementById("nextRoundButton").onclick = () => {
        socket.emit("start_round", { game_id: gameId, player_name: playerName });
        document.getElementById("nextRoundButton").style.display = "none";
        document.querySelector('.cardControls').style.display = 'block';
    };


</script>

<style>
    .flashes {
        list-style: none;
        padding: 0;
        margin: 10px 0;
    }

    .flashes li {
        background-color: #f7baf8;
        color: white;
        padding: 10px;
        margin-bottom: 5px;
        border-radius: 4px;
        border: 1px solid rgb(255, 82, 114);
    }

    #countdown-overlay {
        position: fixed;
        inset: 0;
        background: rgba(240, 168, 0, 0.85);
        z-index: 9999;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .countdown-content {
        text-align: center;
        color: rgb(0, 0, 0);
    }

    #countdown-number {
        font-size: 6rem;
        margin-top: 20px;
    }

    .player_info {
        width: 100%;
        height: 75px;
        padding: 20px;
        text-align: center;
    }

    .current_info {
        display: flex;
        justify-content: center;
        align-items: stretch;
        gap: 20px;
        margin-top: 15px;
    }

    .actor_info,
    .guesser_info {
        flex: 1;
        width: 40%;
        padding: 16px;
        border: 2px solid #ddd;
        border-radius: 8px;

        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;

        font-size: 0.9rem;
    }

    .centered-img {
        display: flex;
        justify-content: center;
    }

    #actor-view {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
    }

    #cardContainer {
        display: flex;
        justify-content: center;
        align-items: center;
        align-self: center;
        min-height: 300px;
        margin-top: 40px;
    }

    .card {
        background: white;
        width: 400px;
        min-height: 250px;
        padding: 24px;
        border-radius: 20px;
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.08);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        position: relative;
        animation: pop 0.3s ease;
    }

    .card h2 {
        font-size: 2rem;
        margin-bottom: 6px;
    }

    .card p {
        opacity: 0.7;
        font-size: 1rem;
        margin-top: 6px;
    }

    .points {
        position: absolute;
        top: 15px;
        right: 20px;
        background: black;
        color: white;
        padding: 6px 10px;
        border-radius: 999px;
        font-size: 0.8rem;
    }

    .cardControls {
        margin-top: 40px;
        display: flex;
        gap: 30px;
        justify-content: center;
    }

    .cardControls button {
        padding: 12px 26px;
        border-radius: 10px;
        border: none;
        font-size: 1.1rem;
        cursor: pointer;
        transition: transform 0.1s ease, box-shadow 0.1s ease;
    }

    #skipBtn {
        background: #f3f3f3;
    }

    #correctBtn {
        background: #2ecc71;
        color: white;
    }

    .cardControls button:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.12);
    }

    .card.empty {
        background: #fafafa;
        color: #aaa;
        font-size: 1.5rem;
    }

    .flowButtons button {
        padding: 12px 26px;
        border-radius: 10px;
        border: none;
        font-size: 1.1rem;
        background: #f3f3f3;
        cursor: pointer;
        transition: transform 0.1s ease, box-shadow 0.1s ease;
    }

    @keyframes pop {
        from {
            transform: scale(0.95);
            opacity: 0;
        }

        to {
            transform: scale(1);
            opacity: 1;
        }
    }
</style>


{% endblock %}